flowchart TB
    subgraph User["Open-WebUI (User)"]
        UserInput["User sends message"]
        UserReads["User reads response"]
    end

    subgraph Filter["Filter.inlet() - memory.filter.py"]
        F1["1. Extract files/images"]
        F2["2. Save chunks to memory"]
        F3["3. Search for context"]
        F4["4. Inject into request"]
    end

    subgraph MemoryAPI["Memory API (FastAPI)"]
        direction TB
        Routes["Routes: /save, /search, /summaries"]
        M1["1. Receive chunks from filter"]
        M2["2. Classify importance"]
        M3["3. Embed with SentenceTransformer"]
        M4["4. Upsert to Qdrant"]
        M5["5. Search for existing context"]
        M6["6. Return context + status"]
    end

    subgraph Qdrant["Qdrant Vector Database"]
        QConfig["Collection: user_memory_collection<br/>Dimension: 768 (all-mpnet-base-v2)<br/>Similarity: COSINE<br/>Threshold: 0.35"]
    end

    subgraph Support["Support Services"]
        Pragmatics["Pragmatics Classifier<br/>Save vs Other Intent<br/>(0.70 threshold)"]
        Extractor["Extractor API<br/>• Image → LLaVA<br/>• Audio → Whisper<br/>• PDF → PyMuPDF<br/>• Code → Chunker"]
    end

    LLM["LLM Response"]

    UserInput --> Filter
    Filter --> MemoryAPI
    MemoryAPI -->|"Embedding"| Qdrant
    MemoryAPI -->|"Search/Upsert"| Qdrant
    MemoryAPI --> Pragmatics
    Filter --> Extractor
    Extractor -->|"Chunks"| MemoryAPI
    MemoryAPI -->|"Context injected"| LLM
    LLM --> UserReads