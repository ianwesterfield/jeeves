networks:
  webtools_network:
    external: true

services:
  # -------------------------------------------------
  # Ollama
  # -------------------------------------------------
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    runtime: nvidia
    environment:
      - OLLAMA_HOST=0.0.0.0
    ports:
      - "11434:11434"
    volumes:
      - C:\\docker-data\\ollama\\.ollama:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    shm_size: 2g
    restart: unless-stopped
    networks:
      - webtools_network

  # -------------------------------------------------
  # Qdrant
  # -------------------------------------------------
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    environment:
      - QDRANT_LOG_LEVEL=DEBUG
      # Flush WAL more frequently to reduce corruption risk on shutdown
      - QDRANT__STORAGE__OPTIMIZERS__FLUSH_INTERVAL_SEC=1
    ports:
      - "5100:5100"
      - "6333:6333"
    volumes:
      - qdrant_storage:/qdrant/storage
    restart: unless-stopped
    # Give Qdrant time to flush WAL and close cleanly
    stop_grace_period: 30s
    networks:
      - webtools_network

  # -------------------------------------------------
  # Memory API
  # -------------------------------------------------
  memory_api:
    build:
      context: ./tools-api
      dockerfile: memory/Dockerfile
    container_name: memory_api
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - INDEX_NAME=user_memory_collection
      - EMBEDDING_PROVIDER=sentence_transformers
      - SUMMARY_MODEL=sshleifer/distilbart-cnn-12-6
      - SUMMARY_DEVICE=cpu
    ports:
      - "8000:8000"
    depends_on:
      - qdrant
    restart: unless-stopped
    networks:
      - webtools_network

  # -------------------------------------------------
  # Pragmatics API
  # -------------------------------------------------
  pragmatics_api:
    build:
      context: ./tools-api/pragmatics
      dockerfile: Dockerfile
    container_name: pragmatics_api
    environment:
      - CLASSIFIER_MODEL=distilbert_memory
    depends_on:
      - memory_api
    restart: unless-stopped
    networks:
      - webtools_network

  # -------------------------------------------------
  # Extractor API (Media -> Text)
  # -------------------------------------------------
  extractor_api:
    build:
      context: ./tools-api/extractor
      dockerfile: Dockerfile
    container_name: extractor_api
    environment:
      - WHISPER_MODEL=base
    volumes:
      # Cache models between restarts
      - extractor_cache:/root/.cache
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped
    networks:
      - webtools_network

  # -------------------------------------------------
  # Open-WebUI
  # -------------------------------------------------
  open-webui:
    image: ghcr.io/open-webui/open-webui:latest
    container_name: open-webui
    depends_on:
      - ollama
    environment:
      - USER_AGENT=WesterfieldCloud-OpenWebUI/1.0
      - GLOBAL_LOG_LEVEL=DEBUG
      - OLLAMA_BASE_URL=http://ollama:11434

      - WEBUI_ADMIN_USERNAME=`$(cat ./secrets/webui_username.txt)` # Reference to local file for admin username
      - WEBUI_ADMIN_PASSWORD=`$(cat ./secrets/webui_password.txt)` # Reference to local file for admin password

      - RAG_EMBEDDING_ENGINE=ollama
      - EMBEDDING_MODEL=BAAI/bge-large-en-v1.5
      - MEMORY_ENABLED=true
      - MEMORY_SHORT_TERM_MEMORY_DEPTH=15
      - TOOLS_FUNCTION_CALLING_ENABLED=true
      - TOOLS_FUNCTION_CALLING_LLMS=ollama
      - MEMORY_API_URL=http://memory_api:8000
      - TOOLS_DISCOVERY_URL=http://memory_api:8000/api/tools
    ports:
      - "8180:8080" # Host 8180 -> Container 8080 (8080 often reserved by Windows/Hyper-V)
    volumes:
      - c:/docker-data/open-webui/data:/app/backend/data
    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 8g
    restart: unless-stopped
    networks:
      - webtools_network

volumes:
  qdrant_storage:
    driver: local
  extractor_cache:
    driver: local
